name: Cypress Cucumber CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  cypress-run:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout repo
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ§ª Run Cypress tests
        run: npm run clean-and-test

      - name: ðŸ“¤ Upload Cypress Reports (HTML)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mochawesome-report
          path: cypress/reports

      - name: ðŸ“‚ Fusionner les rapports JSON
        run: npm run merge-reports

      - name: ðŸ“‚ Convertir en Junit
        run: npm run convert-to-junit

      - name: ðŸ“¡ Upload results to Xray (Cloud)
        if: always() # mÃªme si les tests Ã©chouent, on envoie le rapport
        run: |
          echo "Authentification auprÃ¨s de Xray..."
          AUTH=$(curl -s -H "Content-Type: application/json" \
            -X POST \
            --data "{\"client_id\": \"${{ secrets.XRAY_CLIENT_ID }}\", \"client_secret\": \"${{ secrets.XRAY_CLIENT_SECRET }}\"}" \
            https://xray.cloud.getxray.app/api/v2/authenticate | tr -d '"')
          
          echo "Upload du rapport JUnit vers Xray..."
          curl -s -H "Content-Type: text/xml" \
            -H "Authorization: Bearer $AUTH" \
            -X POST \
            --data-binary @"cypress/reports/junit-results.xml" \
            "https://xray.cloud.getxray.app/api/v2/import/execution/junit?projectKey=${{ secrets.XRAY_PROJECT_KEY }}"